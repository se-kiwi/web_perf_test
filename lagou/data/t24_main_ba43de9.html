define("common/widgets/send-resume/main",["require","exports","module","common/widgets/passport/passport","dep/jquery-validation/dist/jquery.validate","common/widgets/common/validate-custom","common/components/jquery-ajaxfileupload/ajaxfileupload","common/widgets/plat/poster","dep/artTemplate/dist/template","common/static/js/plat_tj_resume_log_amd"],function(require,exports,module){function setCountdown(a,c,v){setTimeout(function(v){return $("#"+c).html(a),0==a?void(v&&v()):void setCountdown(a-1,c,v)},1e3,v)}function initDeliverLog(a){var c={};c.logtype="deliver-"+a,c.position=GetQueryString("i"),c.orderid=null,c.userid=window.CONST_VARS("user").id,c.positionid=$("#jobid").val(),c.url=location.href,c.fromsite=document.referrer||null,logImgLoader("logImgSet",c)}function errorTips(a,c){$.colorbox({html:'<div class="errorTips popup"><table width="100%"><tr><td align="center"><h4 class="error_msg">'+a+'</h4></td></tr><tr><td align="center"><a href="javascript:;" class="btn_s">确&nbsp;定</a></td></tr></table></div>',title:c?c:"错误提示"})}function errorTipsSet(a){$.colorbox({html:'<div class="popup" style="width:460px;"><table width="100%"><tr><td align="center"><h4 class="error_msg" style="width:400px;">'+a+'</h4></td></tr><tr><td align="center"><a href="'+GLOBAL_DOMAIN.ctx+'/resume/myresume.html" target="_blank" class="btn_s">马上去完善</a></td></tr></table></div>',title:"错误提示"})}function sendCV(a,c){$.lgAjax({url:GLOBAL_DOMAIN.ctx+"/mycenterDelay/deliverResumeBeforce.json",type:"POST",async:!1,dataType:"json",data:a}).done(function(r){r.success?($("#deliverResumesSuccess .resume_delay_txt").html(r.msg),10==r.code&&$("#deliverResumesSuccess p.share").removeClass("dn"),isDeliverSuccess=!0,cache.sendedPositionId=a.positionId,events.$el.trigger(events.customs.sendSuc,{reqData:a,resData:r}),$.colorbox({inline:!0,href:$("#deliverResumesSuccess"),title:"投个简历",overlayClose:!1}),$("#recall").length>0&&setCountdown(9,"recall_time",function(){$("#deliverResumesSuccess p.count>i").addClass("dn"),isDeliverSuccess&&cache.sendedPositionId&&(location.href=GLOBAL_DOMAIN.ctx+"/deliverSuccess/success.html?positionId="+cache.sendedPositionId,delete cache.sendedPositionId)}),initDeliverLog(0)):7==r.code?(initDeliverLog(1),errorTipsSet("投递失败："+r.msg,"投个简历")):20==r.code||21==r.code?(cache.resumeType=20==r.code?0:1,cache.resumeId=a.resumeId,a.positionId&&(cache.positionId=a.positionId),$("#deliverResumeConfirm .msg").html(r.msg),$.colorbox({inline:!0,href:$("#deliverResumeConfirm"),title:"投递简历确认"})):31==r.code?(initDeliverLog(1),$("#upperLimit").find("h4").find("i").text(r.msg),$.colorbox({inline:!0,href:$("#upperLimit"),title:"投个简历"})):33==r.code?$.colorbox({inline:!0,href:$("#resumeUnPerfect"),title:"投个简历"}):(initDeliverLog(1),errorTips("投递失败："+(r.msg||"请刷新重试"),"投个简历")),c&&c()})}function file_check(obj,action_url,id,e){if(2==uploadFlag)return!1;uploadFlag=2,$("#loadingImg").css("visibility","visible");var obj=$("#"+id);if(this.AllowExt=".doc,.docx,.pdf,.ppt,.pptx,.txt,.wps",this.FileExt=obj.val().substr(obj.val().lastIndexOf(".")).toLowerCase(),0!=this.AllowExt&&-1==this.AllowExt.indexOf(this.FileExt))"reUploadResume1"==id?$("#setResume span.error").show():"reUploadResume2"==id?$("#setResumeApply span.error").show():(errorTips("只支持word、pdf、ppt、txt、wps格式文件，请重新上传"),$("#loadingImg").css("visibility","hidden")),uploadFlag=1;else{if(""==this.FileExt)return!1;$.ajaxFileUpload({type:"POST",url:action_url,secureuri:!1,fileElementId:id,dataType:"text",success:function(jsonStr){$("#setResumeApply span.error").hide(),$("#resumeSetForm span.error").hide();var json=eval("("+jsonStr+")");if($("#loadingImg").css("visibility","hidden"),json.success){var nearbyName="";nearbyName=json.content.nearbyName.length>18?json.content.nearbyName.substring(0,15)+"...":json.content.nearbyName,$("#resumeSendForm .btn_profile_save").removeAttr("disabled").css("backgroundColor","#019875"),$("#resumeSetForm .btn_profile_save").removeAttr("disabled").css("backgroundColor","#019875"),"reUploadResume1"==id?($("#setResume .uploadedResume").text(nearbyName).attr("title",json.content.nearbyName).removeClass("red"),$("#setResume .downloadResume").removeClass("dn").siblings("span").removeClass("dn"),$("#setResume .reUpload").text("重新上传")):"reUploadResume2"==id?($("#resumeSendForm .resume-group").append(template.compile(resumeTpl)({resume:json.content,lgsctx:GLOBAL_DOMAIN.ctx})),$("#resumeSendForm .radio").length>=5&&$("#resumeSendForm .upload-style")&&$("#resumeSendForm .upload-style").addClass("dn")):source?$.colorbox({inline:!0,href:$("div#uploadFileSuccess"),title:"上传附件简历"}):showResumeList(5)}else-1==json.code?$.colorbox({inline:!0,href:$("div#fileResumeUpload"),title:"附件简历上传失败"}):-2==json.code?$.colorbox({inline:!0,href:$("div#fileResumeUploadSize"),title:"附件简历上传失败"}):(errorTips("简历上传失败，请重新上传"),$("#loadingImg").css("visibility","hidden"));uploadFlag=1},error:function(){errorTips("简历上传失败，请重新上传"),$("#loadingImg").css("visibility","hidden"),uploadFlag=1,$(".btn_s").click(function(){window.location.reload()}),$("body").on("click","#cboxClose",function(){$(this).siblings("#cboxLoadedContent").children("div").hasClass("errorTips")&&window.location.reload()})}})}$("#"+id).val("")}function handleSendCV(a,c,v,h){if(null!=a&&"2"!==a&&"3"!==a)switch(window.CONST_VARS("user").id?window.CONST_VARS("user").activated||(a=1):a=0,codesMap[a]){case"jobIsOffline":case"hasSended":break;case"userIsNotLogIn":PASSPORT.loginPopup();break;case"userIsNotActive":$.colorbox({inline:!0,href:$("#activePop"),title:"邮箱验证"});break;case"sendNoResumeCV":case"sendNoResumePlusCV":if(null==c)return console.error("职位id不能为空");if(null==v)return console.error("简历类型不能为空");cache.positionId=c,source=!0,"sendPlusDefaultCV"===codesMap[a]&&(force_first=!0),sendCV({positionId:c,type:v,resumeId:h,force:!1});break;case"sendResumeCV":case"sendResumePlusCV":if(null==c)return console.error("职位id不能为空");cache.positionId=c,source=!1,$.lgAjax({url:GLOBAL_DOMAIN.ctx+"/mycenterDelay/deliveryMatch.json",type:"POST",data:{positionId:cache.positionId},dataType:"json"}).done(function(o){o.success?showResumeList(a):-1==o.code?$.colorbox({inline:!0,href:$("#notLogin"),title:"错误提示"}):33==o.code?$.colorbox({inline:!0,href:$("#resumeUnPerfect"),title:"投个简历"}):($("#deliverResumeConfirm .msg").html(o.msg),$.colorbox({inline:!0,href:$("#deliverResumeConfirm"),title:"投递简历确认"}))})}}function showResumeList(a){$.lgAjax({url:GLOBAL_DOMAIN.ctx+"/mycenter/resume/getAllResumes.json",type:"GET",dataType:"json"}).done(function(c){c.success&&($("#setResumeApply .resume-select-group").replaceWith(template.compile(resumeMainTpl)({resumeVos:c.content,lgsctx:GLOBAL_DOMAIN.ctx})),$.colorbox({inline:!0,href:$("#setResumeApply"),title:"sendNoResumePlusCV"===codesMap[a]?"接受邀请":"投个简历"}))})}function init(a){function c(){var a=$(this),c=a.attr("data-code"),v=a.attr("data-position-id"),h=a.attr("data-resume-type"),b=a.attr("data-resume-id");null!=c&&(c=c.trim(),window.CONST_VARS("user").id?window.CONST_VARS("user").activated?handleSendCV(c,v,h,b):handleSendCV(1,v,h,b):handleSendCV(0,v,h,b))}null!=a&&(a!==defaultSendCVSelector&&$("body").off("click",defaultSendCVSelector,c),$("body").on("click",a,c))}require("common/widgets/passport/passport"),require("dep/jquery-validation/dist/jquery.validate"),require("common/widgets/common/validate-custom"),require("common/components/jquery-ajaxfileupload/ajaxfileupload"),require("common/widgets/plat/poster");var template=require("dep/artTemplate/dist/template"),resumeTpl='<div class="clear"></div>\n<label class="radio">\n    <input type="radio" name="resumeName" class="resume0" value="0" data-resume-id="{{resume.id}}" checked /> 附件简历： \n    <span class="uploadedResume" title="{{resume.nearbyName}}">{{resume.nearbyName}}</span>\n</label>\n<div class="setBtns" style="cursor:pointer">\n    <a href="{{lgsctx}}/nearBy/downloadResume?id={{resume.id}}" class="downloadResume" style="cursor:pointer">下载</a> \n</div>',resumeMainTpl='<div class="resume-select-group">\n<label class="radio">\n        <input type="radio" name="resumeName" class="resume1" value="1" data-resume-id="{{resumeVos[0].id}}" {{if resumeVos[0].isDefault}}checked {{/if}}  /> 在线简历： \n        {{if resumeVos[0].perfect}}\n        <span title="{{resumeVos[0].name}}">{{resumeVos[0].name}}</span>\n        {{else}}\n        <span class="red">在线简历还不完善，请完善后选择投递</span>\n        {{/if}}\n    </label>\n    <div class="setBtns">\n        {{if resumeVos[0].perfect}}\n        <a href="{{lgsctx}}/resume/preview.html" target="_blank">预览</a>\n        | {{/if}}\n        <a rel="nofollow" href="{{lgsctx}}/resume/myresume.html" target="_blank">修改</a>\n    </div>\n    <div class="resume-group">\n        {{each resumeVos as resumeVo i}}\n        {{if i != 0 && resumeVo.perfect}}\n            <div class="clear"></div>\n            <label class="radio">\n                <input type="radio" name="resumeName" class="resume0" value="0" data-resume-id="{{resumeVo.id}}" {{if resumeVo.isDefault}} checked  {{/if}} /> 附件简历： \n                <span class="uploadedResume" title="{{resumeVo.name}}">{{resumeVo.name}}</span>\n            </label>\n            <div class="setBtns">\n                <a rel="nofollow" href="{{lgsctx}}/nearBy/downloadResume?id={{resumeVo.id}}" class="downloadResume">下载</a>\n            </div>\n            {{/if}}\n        {{/each}}\n    </div>\n    {{if resumeVos.length < 5}} \n    <div class="clear"></div>\n    <div class="upload-style">\n        <a target="_blank" title="上传附件简历" class="reUpload ">上传附件简历</a>\n        <input title="支持word、pdf、ppt、txt、wps格式文件，大小不超过10M" name="newResume" id="reUploadResume2" type="file" />\n    </div>\n    {{/if}} \n</div>',tjResumeLogHelper=require("common/static/js/plat_tj_resume_log_amd"),GetQueryString=tjResumeLogHelper.GetQueryString,logImgLoader=tjResumeLogHelper.logImgLoader,isDeliverSuccess=!1,force_first=!1,source=!0,cache={sendedPositionId:void 0,positionId:void 0,resumeType:void 0,resumeId:void 0},events={$el:$("<div></div>"),customs:{sendSuc:"deliverSuccess",recallSuc:"recalldeliverSuccess"}};$("body").on("click",".errorTips a.btn_s",function(){window.location.reload()}),$("body").on("click","a.btn_s",function(){$.colorbox.close(),parent.jQuery.colorbox.close()}),$(".inline").colorbox({inline:!0}),$(".errorTips").click(function(){errorTips("上传附件格式错误!")}),$("#resumeSendForm, #resumeSetForm").on("click","a.reUpload",function(){var a=$(this),c=a.closest(".popup"),v=c.find('input[type="file"]');c.find("span.error").hide(),v.click()}),$('#resumeSendForm input[type="submit"]').on("click",function(e){e.stopPropagation(),e.preventDefault();var a=cache.positionId,c=$('input[name="resumeName"]:checked',"#resumeSendForm").val(),v=$('input[name="resumeName"]:checked',"#resumeSendForm").data("resume-id");$("#resumeSendForm").find(":submit").attr("disabled",!0),sendCV({positionId:a,type:c,force:source?!1:!0,resumeId:v},function(){$("#resumeSendForm").find(":submit").attr("disabled",!1)})});var uploadFileInputIds=["reUploadResume1","reUploadResume2","resumeUpload","resumeUpload1","resumeUpload2"];uploadFileInputIds.forEach(function(a){$("body").on("change","#"+a,function(){file_check(this,GLOBAL_DOMAIN.ctx+"/nearBy/updateMyResume.json",a)})});var uploadFlag=1,delayConfirmDeliver=$("#delayConfirmDeliver");delayConfirmDeliver.click(function(){if(source){var a=cache.resumeType,c=cache.positionId,v=cache.resumeId;sendCV({positionId:c,force:!0,type:a,resumeId:v})}else showResumeList(4)}),$("#deliverResumeConfirm .edit_field").bind("click",function(){var a=cache.resumeType;openProfileBox(a)}),$("#select_degree").bind("click",function(e){e.stopPropagation(),$("#select_workyear").removeClass("select_focus"),$("#select_expectCity").removeClass("select_focus"),$("#box_workyear").hide(),$("#box_expectCity").hide(),$(this).addClass("select_focus"),$("#box_degree").show()}),$("#box_degree").on("click","ul li",function(e){e.stopPropagation();var a=$(this).text();$("#select_degree").val(a).css("color","#333").removeClass("select_focus"),$("#degree").val(a),$("#box_degree").hide(),$(this).parents("#basicInfoForm").validate().element($("#degree"))}),$("#select_workyear").bind("click",function(e){e.stopPropagation(),$("#select_degree").removeClass("select_focus"),$("#select_expectCity").removeClass("select_focus"),$("#box_degree").hide(),$("#box_expectCity").hide(),$(this).addClass("select_focus"),$("#box_workyear").show()}),$("#box_workyear").on("click","ul li",function(e){e.stopPropagation();var a=$(this).text();$("#select_workyear").val(a).css("color","#333").removeClass("select_focus"),$("#workyear").val(a),$("#box_workyear").hide(),$(this).parents("#basicInfoForm").validate().element($("#workyear"))}),$("#select_expectCity").bind("click",function(e){e.stopPropagation(),$("#select_workyear").removeClass("select_focus"),$("#select_degree").removeClass("select_focus"),$("#box_workyear").hide(),$("#box_degree").hide(),$(this).addClass("select_focus"),$("#box_expectCity").show()}),$("#box_expectCity").on("click","dl dd span",function(e){e.stopPropagation();var a=$(this).text();$("#select_expectCity").val(a).css("color","#333").removeClass("select_focus"),$("#expectCity").val(a),$("#box_expectCity").hide(),$(this).parents("#basicInfoForm").validate().element($("#expectCity"))}),$("body").click(function(){$(".boxUpDown").hide().prev("input").removeClass("select_focus")}),$("#basicInfoForm").validate({ignore:"",rules:{name:{required:!0,truename:!0,rangeLenStr:[1,20]},degree:{required:!0},workyear:{required:!0},expectCity:{required:!0},tel:{required:!0,isMobile:!0,maxlength:20},email:{required:!0,email:!0,maxlength:100}},messages:{name:{required:"请输入你的真实姓名",truename:"请输入你的真实姓名",rangeLenStr:"请输入你的真实姓名"},degree:{required:"请选择最高学历"},workyear:{required:"请选择工作年限"},expectCity:{required:"请选择期望工作城市"},tel:{required:"请输入手机号码",isMobile:"请输入有效的手机号码",maxlength:"目前仅支持有效大陆和海外号码"},email:{required:"请输入接收面试通知邮箱",email:"请输入有效的常用邮箱",maxlength:"输入100字符以内的邮箱地址"}},errorElement:"span",errorPlacement:function(a,c){"hidden"==c.attr("type")?a.appendTo($(c).parent()):a.insertAfter(c)},submitHandler:function(a){var c=$('input[name="name"]',a).val(),v=$('input[name="degree"]',a).val(),h=$('input[name="workyear"]',a).val(),b=$('input[name="expectCity"]',a).val(),g=$('input[name="tel"]',a).val(),y=$.trim($('input[name="email"]',a).val()),_=$('input[name="type"]',a).val();if(null==cache.positionId)return alert("职位id不能为空");var C=cache.positionId;if($(a).find(":submit").attr("disabled",!0),g&&""!=g){var S=removePhoneWord(g.split(""),"-");g=removePhoneWord(S,"+").join("")}var I={name:c,highestEducation:v,workYear:h,city:b,phone:g,email:y,type:_,positionId:C,force:force_first,deliver:!0};fixBasicInfoSendResume(I,function(){$(a).find(":submit").attr("disabled",!1)})}}),$(".upper_close, .btn_upper").on("click",function(){$.colorbox.close()}),$(".cancel").on("click",function(){$.colorbox.close()}),$("body").on("click","#knowed",function(){isDeliverSuccess&&cache.sendedPositionId?(location.href=GLOBAL_DOMAIN.ctx+"/deliverSuccess/success.html?positionId="+cache.sendedPositionId,delete cache.sendedPositionId):location.reload()}),$("#recall").click(function(){$.lgAjax({url:GLOBAL_DOMAIN.ctx+"/mycenterDelay/undoDeliverResume.json",data:{positionId:cache.sendedPositionId},type:"POST",dataType:"json"}).done(function(a){a.success&&($("#deliverResumesSuccess p.count").html("简历已成功撤回。"),isDeliverSuccess=!1,events.$el.trigger(events.customs.recallSuc,{reqData:{positionId:cache.sendedPositionId},resData:a}),delete cache.sendedPositionId,$.colorbox({inline:!0,href:$("#deliverResumesSuccess"),title:"投个简历",overlayClose:!1}),initDeliverLog(2))})}),$("body").on("click","#cboxClose",function(){("deliverResumesSuccess"==$(this).siblings("#cboxLoadedContent").children("div").attr("id")||"uploadFileSuccess"==$(this).siblings("#cboxLoadedContent").children("div").attr("id"))&&(isDeliverSuccess&&cache.sendedPositionId?(location.href=GLOBAL_DOMAIN.ctx+"/deliverSuccess/success.html?positionId="+cache.sendedPositionId,delete cache.sendedPositionId):location.reload())}),$("#activePop .resend").click(function(){$.lgAjax({type:"POST",url:GLOBAL_DOMAIN.ctx+"/user/resendActivatedMail"}).done(function(a){a.success?$.colorbox({inline:!0,href:"#resend_success",title:"验证邮件发送成功"}):alert(a.msg)})}),$("#resumeSetForm").validate({rules:{resumeName:{required:!0}},messages:{resumeName:{required:"请选择默认投递的简历"}},errorPlacement:function(a,c){a.insertBefore($(c).parent().siblings(".setTip.error"))},submitHandler:function(a){var c=$('input[name="resumeName"]:checked',a).val();$(a).find(":submit").attr("disabled",!0),$.lgAjax({url:GLOBAL_DOMAIN.ctx+"/mycenter/resume/setDefaultResume.json",type:"POST",data:{type:c}}).done(function(c){c.success?top.location.reload():console.log(c.msg),$(a).find(":submit").attr("disabled",!1)})}});var codesMap={0:"userIsNotLogIn",1:"userIsNotActive",2:"jobIsOffline",3:"hasSended",4:"sendNoResumeCV","4-1":"sendNoResumePlusCV",5:"sendResumeCV","5-1":"sendResumePlusCV"},defaultSendCVSelector=".send-CV-btn";init(defaultSendCVSelector),module.exports={init:init,handleSendCV:handleSendCV,events:events}});