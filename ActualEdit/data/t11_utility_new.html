function ShortCut(){this.all_shortcuts=new Object,this.add=function(a,b,c){var e,f,h,d={type:"keydown",propagate:!1,disable_in_input:!1,target:document,keycode:!1};if(c)for(e in d)"undefined"==typeof c[e]&&(c[e]=d[e]);else c=d;f=c.target,"string"==typeof c.target&&(f=document.getElementById(c.target)),a=a.toLowerCase(),h=function(d){var e,f,g,h,i,j,l,m,n;if(d=d||window.event,!c["disable_in_input"]||(d.target?e=d.target:d.srcElement&&(e=d.srcElement),3==e.nodeType&&(e=e.parentNode),"INPUT"!=e.tagName&&"TEXTAREA"!=e.tagName&&"SELECT"!=e.tagName)){for(f="",d.keyCode?f=d.keyCode:d.which&&(f=d.which),g=String.fromCharCode(f).toLowerCase(),188==f&&(g=","),190==f&&(g="."),h=a.split("+"),i=0,j={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},l={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},m={shift:{wanted:!1,pressed:!1},ctrl:{wanted:!1,pressed:!1},alt:{wanted:!1,pressed:!1},meta:{wanted:!1,pressed:!1}},d.ctrlKey&&(m.ctrl.pressed=!0),d.shiftKey&&(m.shift.pressed=!0),d.altKey&&(m.alt.pressed=!0),d.metaKey&&(m.meta.pressed=!0),n=0;k=h[n],n<h.length;n++)"ctrl"==k||"control"==k?(i++,m.ctrl.wanted=!0):"shift"==k?(i++,m.shift.wanted=!0):"alt"==k?(i++,m.alt.wanted=!0):"meta"==k?(i++,m.meta.wanted=!0):k.length>1?l[k]==f&&i++:c["keycode"]?c["keycode"]==f&&i++:g==k?i++:j[g]&&d.shiftKey&&(g=j[g],g==k&&i++);return i!=h.length||m.ctrl.pressed!=m.ctrl.wanted||m.shift.pressed!=m.shift.wanted||m.alt.pressed!=m.alt.wanted||m.meta.pressed!=m.meta.wanted||(b(d),c["propagate"])?void 0:(d.cancelBubble=!0,d.returnValue=!1,d.stopPropagation&&(d.stopPropagation(),d.preventDefault()),!1)}},this.all_shortcuts[a]={callback:h,target:f,event:c["type"]},f.addEventListener?f.addEventListener(c["type"],h,!1):f.attachEvent?f.attachEvent("on"+c["type"],h):f["on"+c["type"]]=h},this.remove=function(a){var b,c,d,e;a=a.toLowerCase(),b=this.all_shortcuts[a],delete this.all_shortcuts[a],b&&(c=b["event"],d=b["target"],e=b["callback"],d.detachEvent?d.detachEvent("on"+c,e):d.removeEventListener?d.removeEventListener(c,e,!1):d["on"+c]=!1)}}function initShortCut(){var a=new ShortCut,b={type:"keydown",propagate:!1,disable_in_input:!0};a.add("Alt+1",function(){useShortCutAddNewQ=!0,createFreQ("radio")}),a.add("Alt+2",function(){useShortCutAddNewQ=!0,createFreQ("check")}),a.add("Alt+3",function(){useShortCutAddNewQ=!0,createFreQ("likert")}),a.add("Ctrl+S",function(){save_paper("edit",!0)}),a.add("Ctrl+Z",function(){undo()},b),a.add("Ctrl+Y",function(){redo()},b),a.add("End",function(){questionHolder.length>0&&questionHolder[questionHolder.length-1].scrollIntoView()},b),a.add("Home",function(){questionHolder.length>0&&questionHolder[0].scrollIntoView()},b)}function makeDrag(a){new Drag(a,{container:questions,limit:!0,ghosting:!0,lockX:!0,scroll:!0,onDrag:moveQ,handle:"div_preview"})}function moveQ(a,b){var f,g,h,i,j,k,l,c=mouseCoords(a),d=c.y-b.offset_y,e=d+b.offsetHeight/2;for(f=questionHolder.length-1;f>=0;f--)if(g=questionHolder[f],g!=b&&(h=getCoords(g),i=h.top,e>i&&e<i+questionHolder[f].offsetHeight)){if(d>i){if(b._referDivQ&&(j=parseInt(g.dataNode._topic)-1,k=b._referDivQ.dataNode._topic,k>j))return l="选项",("matrix"==b.dataNode._type||"sum"==b.dataNode._type)&&(l="行标题"),show_status_tip("此题"+l+"来源于第"+k+"题的选中项，不能再将此题移到第"+k+"题上方！",4e3),g.onmouseout(),void 0;b.parentNode.insertBefore(b,g),recreateEditor(b),recreateEditor(g),questionHolder.moveTo(b,questionHolder.indexOf(g))}else{if(b._referedArray)for(j=parseInt(g.dataNode._topic)+1,f=0;f<b._referedArray.length;f++)if(k=b._referedArray[f].dataNode._topic,j-k>0)return l="选项",("matrix"==b._referedArray[f].dataNode._type||"sum"==b._referedArray[f].dataNode._type)&&(l="行标题"),show_status_tip("第"+k+"题的"+l+"来源于此题的选中项，不能将此题移到第"+k+"题下方！",4e3),void 0;g.parentNode.insertBefore(b,g),g.parentNode.insertBefore(g,b),recreateEditor(b),recreateEditor(g),questionHolder.moveTo(b,questionHolder.indexOf(g))}updateTopic()}}var getStyle,Drag,i;if(initShortCut(),getStyle=function(a,b){return document.defaultView.getComputedStyle(a,null).getPropertyValue(b)},Drag=function(a){var u,v,w,x,y,z,A,B,C,D,E,F,b=a,c=document.documentMode?5==document.documentMode:document.compatMode&&"CSS1Compat"!=document.compatMode,d=arguments[1]||{},e=d.container||document.documentElement,f=d.limit,g=d.lockX,h=d.lockY,i=d.ghosting,j=d.handle,k=d.revert,l=d.scroll,m=d.coords,n=d.onStart||function(){},o=d.onDrag||function(){},p=d.onEnd||function(){},q=parseFloat(getStyle(b,"margin-left")),r=parseFloat(getStyle(b,"margin-right")),s=parseFloat(getStyle(b,"margin-top")),t=parseFloat(getStyle(b,"margin-bottom"));if(b.lockX=getCoords(b).left,b.lockY=getCoords(b).top,j)for(u=new RegExp("(^|\\s)"+j+"(\\s|$)"),A=0,B=b.childNodes.length;B>A;A++)if(C=b.childNodes[A],1==C.nodeType&&u.test(C.className)){v=C;break}z=(v||b).innerHTML,D=function(a){var c,d;return a=a||window.event,c=mouseCoords(a),b.clickOriginY=c.y,d=getCoords(b),b.offset_x=c.x-d.left,b.offset_y=c.y-d.top,document.onmouseup=F,document.onmousemove=E,i&&(w=b.cloneNode(!1),b.parentNode.insertBefore(w,b.nextSibling),v&&(v=v.cloneNode(!1),w.appendChild(v)),w.style.position="fixed",w.style.background="#ffff66",w.style.width=b.offsetWidth+"px",w.style.height=b.offsetHeight+"px",w.style.display="none",w.innerHTML="<span style='margin-left:50px'>"+b.dataNode._title+"</span>",w.style.opacity=.5),(w||b).style.zIndex=++Drag.z,n(),!1},E=function(a){var i,j,k,n,p,u,z,A,B;a=a||window.event,i=mouseCoords(a),Math.abs(b.clickOriginY-i.y)<=3||b.isEditing||(window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),i=mouseCoords(a),y=i.x-b.offset_x,x=i.y-b.offset_y,w.style.display="",w.style.cursor="pointer",b.style.visibility="hidden",l&&(j=c?document.body:document.documentElement,j=d.container.parentNode||j),f&&(k=y+b.offsetWidth,n=x+b.offsetHeight,p=getCoords(e),u=p.left,z=p.top,A=u+e.clientWidth,B=z+e.clientHeight,y=Math.max(y,u),x=Math.max(x,z),k>A&&(y=A-b.offsetWidth-q-r),n>B&&(x=B-b.offsetHeight-s-t)),g&&(y=b.lockX),h&&(x=b.lockY),(w||b).style.left=y+"px",(w||b).style.top=x+"px",m&&((v||w||b).innerHTML=y+" x "+x),o(a,b))},F=function(){document.onmouseup=null,document.onmousemove=null,w&&b.parentNode.removeChild(w),b.style.visibility="visible",k&&(b.style.left=b.lockX+"px",b.style.top=b.lockY+"px"),p()},Drag.z=999,(v||b).onmousedown=D},!isMergeAnswer)for(i=0;i<questionHolder.length;i++)makeDrag(questionHolder[i]);